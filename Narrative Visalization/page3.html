<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>CS-416 Narative Visualization Project</title>
        <link rel="stylesheet" href="css/styles3.css">
		<script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
        <script src='https://unpkg.com/simple-statistics@7.7.0/dist/simple-statistics.min.js'>
        </script>
    </head>
    <body>
        <h1>Is there a relationship between Nation's Wealth and Mortality Rate of it's people? </h1>
        
        <a id="a1" href="page2.html" title="same dir link">Next page</a>
        <div class="mainView">
            <div class="Box1">
                <h2>GDP vs Female<br> Mortality Rate</h2>
                <svg id="GDPperCapita_FemaleMortalityChart"></svg>
                
            </div>
            <div class="Box2">
                <h2>GDP vs Male<br> Mortality Rate</h2>
                <svg id="GDPperCapita_MaleMortalityChart"></svg>
            </div>
            
        </div>
        <div id="SliderBar1">
            <input type="range" name="mySlider1" id=FemaleSlider min="2002" max="2018" step="1" value="2018">
        </div>
        <div id="SliderBar2">
            <input type="range" name="mySlider2" id=MaleSlider min="2002" max="2018" step="1" value="2018">
        </div>
        <div class="BelowMainViewText"></div>
    </body>
    <script>
        let WDIdataset = {};

        function loadData(){
            let promise = d3.csv("WDIData_WDIData2.csv"); //WDIData_Full Data_Scrubbed2.csv
            //return Promise.all([d3.csv("WDIData_WDIData2.csv"),
            return promise.then(AllData => {
                WDIdataset.WDIData = AllData;
                //WDIdataset.geoJSON = AllData[1]
                return WDIdataset;
            })
        }

        function groupByFemaleMortality(data) { 
            Count = 0;
            let result = data.reduce((result, d) => {
                if (d["Indicator Code"] === "SP.DYN.AMRT.FE"){
                    let currentData = {
                        "Country Code": d["Country Code (WDICountry.csv)"],   
                        "Country Name": d["Country Name"],
                        "Female Mortality Rate": +d["Mortality rate, Female"],
                        "Year": +d["Year"]
                    };
                    //console.log(currentData);
                    result[Count] = currentData;
                    Count += 1;
                };
                return result;
            }, {})
    
            //Need to map objects to list. It seems to work better
            result = Object.keys(result).map(key => result[key])
            result = result.sort((a,b) => {
                return d3.ascending(a["Country Code"], b["Country Code"]);
            })
            return result
        }

        function groupByMaleMortality(data) { 
            Count = 0;
            let result = data.reduce((result, d) => {
                if (d["Indicator Code"] === "SP.DYN.AMRT.MA"){
                    let currentData = {
                        "Country Code": d["Country Code (WDICountry.csv)"],
                        "Country Name": d["Country Name"],
                        "Male Mortality Rate": +d["Mortality rate, Male"],
                        "Year": +d["Year"]
                    };
                    //console.log(currentData);
                    result[Count] = currentData;
                    Count += 1;
                };
                return result;
            }, {})
    
            //Need to map objects to list. It seems to work better
            result = Object.keys(result).map(key => result[key])
            result = result.sort((a,b) => {
                return d3.ascending(a["Country Code"], b["Country Code"]);
            })
            return result
        }

        function groupByPopulation(data) { 
            Count = 0;
            let result = data.reduce((result, d) => {
                if (d["Indicator Code"] === "SP.POP.TOTL"){
                    let currentData = {
                        "Country Code": d["Country Code (WDICountry.csv)"],
                        "Country Name": d["Country Name"],
                        "Population": +d["Total Population"],
                        "Year": +d["Year"]
                    };
                    //console.log(currentData);
                    result[Count] = currentData;
                    Count += 1;
                };
                return result;
            }, {})
    
            //Need to map objects to list. It seems to work better
            result = Object.keys(result).map(key => result[key])
            result = result.sort((a,b) => {
                return d3.ascending(a["Country Code"], b["Country Code"]);
            })
            return result
        }

        function groupByLifeExpectancy(data) { 
            Count = 0;
            let result = data.reduce((result, d) => {
                if (d["Indicator Code"] === "SP.DYN.LE00.IN"){
                    let currentData = {
                        "Country Code": d["Country Code (WDICountry.csv)"],
                        "Country Name": d["Country Name"],
                        "Life Expectancy": +d["Life Expectancy"],
                        "Year": +d["Year"]
                    };
                    //console.log(currentData);
                    result[Count] = currentData;
                    Count += 1;
                };
                return result;
            }, {})
    
            //Need to map objects to list. It seems to work better
            result = Object.keys(result).map(key => result[key])
            result = result.sort((a,b) => {
                return d3.ascending(a["Country Code"], b["Country Code"]);
            })
            return result
        }

        function groupByGDPperCapita(data) {
            Count = 0;
            let result = data.reduce((result, d) => {
                if (d["Indicator Code"] === "NY.GDP.PCAP.KD"){
                    let currentData = {
                        "Country Code": d["Country Code (WDICountry.csv)"],
                        "Country Name": d["Country Name"],
                        "Income Group": d["Income Group"],
                        "GDP per Capita": +d["GDP per capita"],
                        "Year": +d["Year"]
                    };
                    //console.log(currentData);
                    result[Count] = currentData;
                    Count += 1;
                };
               return result
            }, {})
    
            //Need to map objects to list. It seems to work better
            result = Object.keys(result).map(key => result[key])
            result = result.sort((a,b) => {
                return d3.ascending(a["Country Code"], b["Country Code"]);
            })
            return result
        }

        function groupByHealthExpenditureperCapita(data) {
            Count = 0;
            let result = data.reduce((result, d) => {
                if (d["Indicator Code"] === "SH.XPD.CHEX.PC.CD"){
                    let currentData = {
                        "Country Code": d["Country Code (WDICountry.csv)"],
                        "Country Name": d["Country Name"],
                        "Curr Health expenditure per cap": +d["Curr Health expenditure per cap"],
                        "Year": +d["Year"]
                    };
                    //console.log(currentData);
                    result[Count] = currentData;
                    Count += 1;
                };
               return result
            }, {})
    
            //Need to map objects to list. It seems to work better
            result = Object.keys(result).map(key => result[key])
            result = result.sort((a,b) => {
                return d3.ascending(a["Country Code"], b["Country Code"]);
            })
            return result
        }

        function mergeData(GDP,MortalityRate){
            GDP = GDP.sort((a,b) => {
                return d3.ascending(a["Year"], b["Year"]);
            });

            MortalityRate = MortalityRate.sort((a,b) => {
                return d3.ascending(a["Year"], b["Year"]);
            });
            
            let mergedData = {};
            
            for (let i = 0; i < MortalityRate.length; i++) {
                if ((GDP[i]["Country Code"] === MortalityRate[i]["Country Code"]) && (GDP[i]["Year"] == MortalityRate[i]["Year"])) {
                    mergedData[i] = Object.assign({},MortalityRate[i], GDP[i]);
                }
            };
            mergedData = Object.keys(mergedData).map(key => mergedData[key]);
            mergedData = mergedData.sort((a,b) => {
                return d3.ascending(a["Country Code"], b["Country Code"]);
            })   
            return mergedData;
        }
        

        function getConfig(stringValue, width, height) {
            let margin = {
                top: 10,
                bottom: 50,
                left: 130,
                right: 10
                };
            
            //The body is the area that will be occupied by the scatterplot.
            let bodyHeight = height - margin.top - margin.bottom;
            let bodyWidth = width - margin.left - margin.right; 

            //The container is the SVG where we will draw the scatterplot. 
            let container = d3.select(stringValue); 
            container.attr("width", width)
                     .attr("height", height)
            
            return { width, height, margin, bodyHeight, bodyWidth, container };
        }

        
        
        function getCircleScales(xValue, yValue, Mortality, config) {
            let { bodyWidth, bodyHeight } = config;
            
            let maximumPopulation = d3.max(Mortality, d =>{
                return d["Population"];
            });    
        
            let xScale = d3.scaleLinear()
                           .range([0, bodyWidth]) 
                           .domain([0, xValue])
             
            let yScale = d3.scaleLinear()
                           .range([0, bodyHeight])
                           .domain([yValue, 0])

            let rScale = d3.scaleLinear()
                           .range([0,50])
                           .domain([0, maximumPopulation])   

            let colorScale = d3.scaleSequential()
                               .domain([0,1])
                               .interpolator(d3.interpolateCool)
                  
            return { xScale, yScale, rScale, colorScale };
        } 

        
        function reDrawCircles(scales, body, Year, xString, maxHealth){
            let {xScale, yScale, rScale, colorScale} = scales;
            
            let dataset = WDIdataset.MergedData;
            let durationTime = 1000;
            //console.log(Year)

            body.selectAll("circle")
                .data(dataset)
                .transition()
                .duration(durationTime)
                .attr("cx", function(d) {
                                     if (d["Year"]== Year) {
                                          return xScale(d[xString])
                                          } else { return 0}})
                .attr("cy", function(d) {
                                      if (d["Year"]== Year) {
                                          return yScale(d["GDP per Capita"])
                                          } else {return 0}})
                .attr("r", function(d) {
                                      if (d["Year"]== Year) {
                                          return rScale(d["Population"])
                                          } else {return 0}})
                .attr("fill", function(d) {
                                      if (d["Year"]== Year){
                                          return colorScale(d["Curr Health expenditure per cap"]/maxHealth)
                                          }})
                .select("title")
                .text(function(d){
                                      if ((d["Year"]== Year) && (xString == "Male Mortality Rate")) {
                                          return "Country Name: " + d["Country Name"] + "\n" + "Income Group: " + d["Income Group"] + "\n" +
                                                 "Curr Health expenditure per cap: " + d["Curr Health expenditure per cap"] + "\n" +
                                                 "GDP per Capita: " + d["GDP per Capita"] + "\n" + "Population: " + d["Population"] + "\n" + 
                                                 "Male Mortality Rate: " + d["Male Mortality Rate"] + "\n" +
                                                 "Life Expectancy: " + d["Life Expectancy"] + "\n" + "Year: " + d["Year"];
                                                 } else if ((d["Year"]== Year) && (xString == "Female Mortality Rate")) {
                                                     return "Country Name: " + d["Country Name"] + "\n" + "Income Group: " + 
                                                            d["Income Group"] + "\n" + "Curr Health expenditure per cap: " + 
                                                            d["Curr Health expenditure per cap"] + "\n" + "GDP per Capita: " + 
                                                            d["GDP per Capita"] + "\n" + "Population: " + d["Population"] + "\n" + 
                                                            "Female Mortality Rate: " + d["Female Mortality Rate"] + "\n" +
                                                            "Life Expectancy: " + d["Life Expectancy"] + "\n" + "Year: " + d["Year"];
                                                            } else {
                                                                return "Country Name: " + d["Country Name"] + "\n" + "Income Group: " + 
                                                                       d["Income Group"] + "\n" + "Curr Health expenditure per cap: " + 
                                                                       d["Curr Health expenditure per cap"] + "\n" + "GDP per Capita: " + 
                                                                       d["GDP per Capita"] + "\n" + "Population: " + d["Population"] + "\n" + 
                                                                       "Life Expectancy: " + d["Life Expectancy"] + "\n" + "Year: " + 
                                                                       d["Year"];
                                                                       }})
                                                                             
        }
        


        function drawScatterPlot(MergedData, scales, config, Year, xString, maxHealth) {
            let {margin, container} = config; // this is equivalent to 'let margin = config.margin; let container = config.container'
            let {xScale, yScale, rScale, colorScale} = scales;
            let body = container.append("g")
                                .style("transform", `translate(${margin.left}px,${margin.top}px)`)

            let ScatterPlots = body.selectAll("circle")
                                   .data(MergedData)

            ScatterPlots.enter()
                        .append("circle")
                        .attr("cx", function(d) {
                            if (d["Year"]== Year) {
                                return xScale(d[xString])
                            } else { return 0}})
                            
                        .attr("cy", function(d) {
                            if (d["Year"]== Year) {
                                return yScale(d["GDP per Capita"])
                            } else {return 0}})
                        .attr("r", function(d) {
                            if (d["Year"]== Year) {
                                return rScale(d["Population"])
                        } else {return 0}})
                        .attr("fill", function(d) {
                             if (d["Year"]== Year){
                                 return colorScale(d["Curr Health expenditure per cap"]/maxHealth)
                             }})    
                        .append("title")
                        .text(function(d){
                             if ((d["Year"]== Year) && (xString == "Male Mortality Rate")) {
                                 return "Country Name: " + d["Country Name"] + "\n" + "Income Group: " + d["Income Group"] + "\n" +
                                 "Curr Health expenditure per cap: " + d["Curr Health expenditure per cap"] + "\n" +
                                 "GDP per Capita: " + d["GDP per Capita"] + "\n" + "Population: " + d["Population"] + "\n" + 
                                 "Male Mortality Rate: " + d["Male Mortality Rate"] + "\n" +
                                 "Life Expectancy: " + d["Life Expectancy"] + "\n" + "Year: " + d["Year"];
                              } else if ((d["Year"]== Year) && (xString == "Female Mortality Rate")) {
                                 return "Country Name: " + d["Country Name"] + "\n" + "Income Group: " + d["Income Group"] + "\n" +
                                 "Curr Health expenditure per cap: " + d["Curr Health expenditure per cap"] + "\n" +
                                 "GDP per Capita: " + d["GDP per Capita"] + "\n" + "Population: " + d["Population"] + "\n" + 
                                 "Female Mortality Rate: " + d["Female Mortality Rate"] + "\n" +
                                 "Life Expectancy: " + d["Life Expectancy"] + "\n" + "Year: " + d["Year"];
                              }
                            else {
                                return "Country Name: " + d["Country Name"] + "\n" + "Income Group: " + d["Income Group"] + "\n" +
                                 "Curr Health expenditure per cap: " + d["Curr Health expenditure per cap"] + "\n" +
                                 "GDP per Capita: " + d["GDP per Capita"] + "\n" + "Population: " + d["Population"] + "\n" + 
                                 "Life Expectancy: " + d["Life Expectancy"] + "\n" + "Year: " + d["Year"];
                            }})
                           
            return body;                 
        }


        function drawAxesChart(mergedData, scales, config){
            let {xScale, yScale} = scales;
            let {container, margin, height} = config;

            let axisX = d3.axisBottom(xScale)
                          .ticks(5)

            container.append("g")
                     .style("transform",`translate(${margin.left}px,${height - margin.bottom}px)`)
                     .call(axisX)
                     .append("text")
                     .attr("y", 30)
                     .attr("x", 250)
                     .attr("text-anchor", "middle")
                     .attr("stroke", "black")
                     .text("Female Mortality Rate");
                     

            let axisY = d3.axisLeft(yScale)
                          

            container.append("g")
                     .style("transform",`translate(${margin.left}px,${margin.top}px)`)
                     .call(axisY)
                     .append("text")
                     .attr("transform", "rotate(0)")
                     .attr("x", -75) //-50
                     .attr("y", height - 280) //300
                     .attr("dy", "-5.1em")
                     .attr("text-anchor", "middle")
                     .attr("stroke", "black")
                     .text("GDP per Capita");
                     
        }
        
        function CreateAnnotations(id, labeltext, titletext, xVal, yVal, dxVal,dyVal){
            const annotations = [
                {
                    note: {
                        label: labeltext,
                        title: titletext
                    },
                    x: xVal,
                    y: yVal,
                    dy: dyVal,
                    dx: dxVal
                }
            ]

            const makeAnnotations = d3.annotation()
                                      .annotations(annotations)

            d3.select(id) //id
                .append("g")
                .call(makeAnnotations)    

        }

                
        function showData(){
            let BoxWidth = 700;
            let BoxHeight = 600;
            let xValue = 450;
            let yValue = 65000; 
            WDIdataset.Year = 2018;

            //Preprocessing the data
            let FemaleMor = groupByFemaleMortality(WDIdataset.WDIData);
            let GDPperCap = groupByGDPperCapita(WDIdataset.WDIData);
            let Population = groupByPopulation(WDIdataset.WDIData);
            let MaleMor = groupByMaleMortality(WDIdataset.WDIData);
            let LifeExp = groupByLifeExpectancy(WDIdataset.WDIData);
            let HeatlthExp = groupByHealthExpenditureperCapita(WDIdataset.WDIData);
            
            let MergedData = mergeData(HeatlthExp,mergeData(LifeExp,mergeData(MaleMor,mergeData(Population,mergeData(FemaleMor, GDPperCap)))));
            WDIdataset.MergedData = MergedData;

            let maxHealth = d3.max(MergedData, d =>{
                return d["Curr Health expenditure per cap"];
            });
           
            //Configure and draw 
            let FemaleConfig = getConfig("#GDPperCapita_FemaleMortalityChart", BoxWidth, BoxHeight);
            let FemScales = getCircleScales(xValue, yValue, MergedData, FemaleConfig)
            let FemaleBody = drawScatterPlot(MergedData, FemScales, FemaleConfig, WDIdataset.Year, "Female Mortality Rate",maxHealth);
            drawAxesChart(MergedData, FemScales, FemaleConfig);


            //Configure and draw 
            let MaleConfig = getConfig("#GDPperCapita_MaleMortalityChart", BoxWidth, BoxHeight);
            let MaleScales = getCircleScales(xValue, yValue, MergedData, FemaleConfig)
            let MaleBody = drawScatterPlot(MergedData, MaleScales, MaleConfig, WDIdataset.Year, "Male Mortality Rate", maxHealth);
            drawAxesChart(MergedData, MaleScales, MaleConfig);


            

            let titletext = "The decay exponential hypothesis";
            let labeltext = "The overall trend for the 2018 is" + "\n" +
                            "that overall the higher the " + "\n" +
                            "GDP per Capita, the lower the" + "\n" +
                            "mortality rate for females."
            
            let { FemChart_width, FemChart_height, margin } = FemaleConfig;                
            let xVal = margin.left + 400;
            let yVal = margin.top + 4;
            let dxVal = 0;
            let dyVal = 0;                 

            CreateAnnotations("#GDPperCapita_FemaleMortalityChart", labeltext, titletext, xVal, yVal, dxVal,dyVal)

            d3.select("#MaleSlider")
              .on("change", function(){
                  selectedYear = this.value;
                  //document.getElementById("SliderBar2").innerHTML = selectedYear;
                  reDrawCircles(MaleScales, MaleBody, +selectedYear, "Male Mortality Rate", maxHealth);
                                
              })
              
            d3.select("#FemaleSlider")
              .on("change", function(){
                  selectedYear = this.value;
                  //document.getElementById("SliderBar2").innerHTML = selectedYear;
                  reDrawCircles(FemScales, FemaleBody, +selectedYear, "Female Mortality Rate", maxHealth);
                                
              })        
             
        }

        loadData().then(showData);
        

    </script>    
</html>